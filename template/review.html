<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notebook Review</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a1a;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
    }

    /* Stats bar at top */
    .stats-bar {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      padding: 8px 16px;
      background: #16213e;
      border-bottom: 1px solid #0f3460;
      flex-shrink: 0;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .stat-label {
      font-size: 10px;
      color: #7f8c8d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 14px;
      font-weight: 600;
      color: #e0e0e0;
    }

    /* Tab bar */
    .tab-bar {
      display: flex;
      background: #111;
      border-bottom: 1px solid #0f3460;
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 8px 20px;
      background: transparent;
      border: none;
      color: #7f8c8d;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #ccc; }
    .tab-btn.active {
      color: #e94560;
      border-bottom-color: #e94560;
    }

    /* JupyterLite iframe */
    #jupyter-frame {
      flex: 1;
      width: 100%;
      border: none;
    }

    /* Event timeline panel */
    #timeline-panel {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    #timeline-panel.visible { display: block; }

    .timeline-section h2 {
      font-size: 16px;
      color: #e94560;
      margin-bottom: 12px;
    }
    .timeline-bar {
      height: 24px;
      background: #16213e;
      border-radius: 4px;
      position: relative;
      margin-bottom: 12px;
      overflow: hidden;
      border: 1px solid #0f3460;
    }
    .timeline-marker {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background: #e94560;
      opacity: 0.7;
    }
    .timeline-marker.exec { background: #3498db; }
    .timeline-marker.submit { background: #27ae60; width: 3px; }

    .timeline-legend {
      display: flex;
      gap: 16px;
      font-size: 11px;
      color: #7f8c8d;
      margin-bottom: 12px;
    }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    .event-list {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #0f3460;
      border-radius: 6px;
    }
    .event-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 12px;
      font-size: 12px;
      border-bottom: 1px solid #0f3460;
    }
    .event-item:last-child { border-bottom: none; }
    .event-time {
      color: #7f8c8d;
      font-family: monospace;
      min-width: 60px;
    }
    .event-icon { width: 16px; text-align: center; }
    .event-desc { color: #ccc; }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }

    /* Loading state */
    #loading-message {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      color: #7f8c8d;
      font-size: 16px;
    }
    #loading-message.hidden { display: none; }
  </style>
</head>
<body>
  <div id="stats-bar" class="stats-bar"></div>
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="notebook">Notebook</button>
    <button class="tab-btn" data-tab="timeline">Event Timeline</button>
  </div>
  <div id="loading-message">Loading student notebook...</div>
  <iframe id="jupyter-frame" style="display:none"></iframe>
  <div id="timeline-panel"></div>

  <script src="/public/zest-bridge.js"></script>
  <script>
  (function () {
    'use strict';

    var JUPYTERLITE_URL = 'lite/lab/index.html';
    var NOTEBOOK_FILE = 'assignment.ipynb';
    var _jupyterFrame = document.getElementById('jupyter-frame');
    var _extensionReady = false;
    var _pendingRequests = {};
    var _requestId = 0;

    // -------------------------------------------------------------------
    // Tab switching
    // -------------------------------------------------------------------
    var tabBtns = document.querySelectorAll('.tab-btn');
    for (var i = 0; i < tabBtns.length; i++) {
      tabBtns[i].addEventListener('click', function () {
        var tab = this.getAttribute('data-tab');
        for (var j = 0; j < tabBtns.length; j++) {
          tabBtns[j].classList.remove('active');
        }
        this.classList.add('active');

        if (tab === 'notebook') {
          _jupyterFrame.style.display = 'block';
          document.getElementById('timeline-panel').classList.remove('visible');
        } else {
          _jupyterFrame.style.display = 'none';
          document.getElementById('timeline-panel').classList.add('visible');
        }
      });
    }

    // -------------------------------------------------------------------
    // Helpers
    // -------------------------------------------------------------------
    function formatTime(seconds) {
      if (seconds < 60) return seconds + 's';
      var m = Math.floor(seconds / 60);
      var s = seconds % 60;
      if (m < 60) return m + 'm ' + s + 's';
      var h = Math.floor(m / 60);
      m = m % 60;
      return h + 'h ' + m + 'm';
    }

    function escapeHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // -------------------------------------------------------------------
    // PostMessage to JupyterLite bridge-shim
    // -------------------------------------------------------------------
    function sendToExtension(action, data) {
      if (!_jupyterFrame || !_jupyterFrame.contentWindow) return Promise.reject(new Error('No iframe'));

      var id = 'req_' + (++_requestId);
      var msg = {
        type: 'zest-jupyter',
        action: action,
        requestId: id,
        data: data || {}
      };

      return new Promise(function (resolve, reject) {
        var timeout = setTimeout(function () {
          delete _pendingRequests[id];
          reject(new Error('Request timeout: ' + action));
        }, 15000);

        _pendingRequests[id] = function (responseData) {
          clearTimeout(timeout);
          resolve(responseData);
        };

        _jupyterFrame.contentWindow.postMessage(msg, '*');
      });
    }

    window.addEventListener('message', function (event) {
      if (!_jupyterFrame || event.source !== _jupyterFrame.contentWindow) return;
      var msg = event.data;
      if (!msg || msg.type !== 'zest-jupyter') return;

      // Handle responses to pending requests
      if (msg.requestId && _pendingRequests[msg.requestId]) {
        _pendingRequests[msg.requestId](msg.data);
        delete _pendingRequests[msg.requestId];
        return;
      }

      // Handle ready signal from bridge-shim
      if (msg.action === 'ready') {
        _extensionReady = true;
        onShimReady();
      }
    });

    // -------------------------------------------------------------------
    // Render stats bar
    // -------------------------------------------------------------------
    function renderStats(stats) {
      var bar = document.getElementById('stats-bar');
      if (!bar || !stats) return;

      var items = [
        { label: 'Time Spent', value: formatTime(stats.timeSpent || 0) },
        { label: 'Cell Executions', value: (stats.cellExecutions || 0).toString() },
        { label: 'Interactions', value: (stats.interactions || 0).toString() },
        { label: 'Cells', value: (stats.cellCount || 0).toString() },
        { label: 'Files', value: (stats.fileCount || 0).toString() }
      ];

      bar.innerHTML = items.map(function (item) {
        return '<div class="stat-item">' +
          '<span class="stat-label">' + item.label + '</span>' +
          '<span class="stat-value">' + item.value + '</span>' +
          '</div>';
      }).join('');
    }

    // -------------------------------------------------------------------
    // Render event timeline
    // -------------------------------------------------------------------
    function renderTimeline(events) {
      var panel = document.getElementById('timeline-panel');
      if (!panel || !events || events.length === 0) {
        panel.innerHTML = '<div class="timeline-section"><h2>Event Timeline</h2>' +
          '<div class="no-data">No events recorded</div></div>';
        return;
      }

      var startTime = events[0].t;
      var endTime = events[events.length - 1].t;
      var duration = Math.max(endTime - startTime, 1);

      var html = '<div class="timeline-section"><h2>Event Timeline</h2>';

      // Timeline bar
      html += '<div class="timeline-bar">';
      for (var i = 0; i < events.length; i++) {
        var pct = ((events[i].t - startTime) / duration) * 100;
        var cls = 'timeline-marker';
        if (events[i].type === 'cell_executed') cls += ' exec';
        if (events[i].type === 'submission') cls += ' submit';
        html += '<div class="' + cls + '" style="left:' + pct + '%"></div>';
      }
      html += '</div>';

      // Legend
      html += '<div class="timeline-legend">';
      html += '<div class="legend-item"><span class="legend-dot" style="background:#e94560"></span> Events</div>';
      html += '<div class="legend-item"><span class="legend-dot" style="background:#3498db"></span> Cell Executions</div>';
      html += '<div class="legend-item"><span class="legend-dot" style="background:#27ae60"></span> Submission</div>';
      html += '</div>';

      // Event list
      html += '<div class="event-list">';
      var eventIcons = {
        'session_start': '\u25B6', 'cell_executed': '\u26A1',
        'cell_exec_scheduled': '\u23F3', 'notebook_opened': '\uD83D\uDCD3',
        'state_restored': '\uD83D\uDD04', 'files_restored': '\uD83D\uDCC2',
        'extension_ready': '\u2713', 'submission': '\u2705'
      };
      var eventLabels = {
        'session_start': 'Session started', 'cell_executed': 'Cell executed',
        'cell_exec_scheduled': 'Cell queued', 'notebook_opened': 'Notebook opened',
        'state_restored': 'State restored', 'files_restored': 'Files restored',
        'extension_ready': 'Environment ready', 'submission': 'Work submitted'
      };

      for (var i = 0; i < events.length; i++) {
        var ev = events[i];
        var relTime = ev.t - startTime;
        var icon = eventIcons[ev.type] || '\u2022';
        var label = eventLabels[ev.type] || ev.type;

        if (ev.type === 'cell_executed' && ev.data) {
          label += ' (cell ' + ev.data.cellIndex + ', ' + (ev.data.success ? 'OK' : 'error') + ')';
        }
        if (ev.type === 'submission' && ev.data && ev.data.fileCount) {
          label += ' (' + ev.data.fileCount + ' files)';
        }

        html += '<div class="event-item">';
        html += '<span class="event-time">+' + formatTime(relTime) + '</span>';
        html += '<span class="event-icon">' + icon + '</span>';
        html += '<span class="event-desc">' + escapeHtml(label) + '</span>';
        html += '</div>';
      }
      html += '</div></div>';

      panel.innerHTML = html;
    }

    // -------------------------------------------------------------------
    // Load submitted notebook into JupyterLite
    // -------------------------------------------------------------------
    var _submittedNotebook = null;
    var _submittedFiles = null;
    var _notebookLoaded = false;

    function onShimReady() {
      console.log('[review] Bridge-shim ready, _notebookLoaded=' + _notebookLoaded);

      var loadingMsg = document.getElementById('loading-message');

      // After loadNotebook, bridge-shim writes to IndexedDB and reloads the iframe.
      // On the second "ready" signal (after reload), skip re-sending to avoid infinite loop.
      if (_notebookLoaded) {
        console.log('[review] Notebook already loaded — skipping restore, showing iframe');
        if (loadingMsg) loadingMsg.classList.add('hidden');
        _jupyterFrame.style.display = 'block';
        return;
      }

      // Load the submitted notebook into JupyterLite
      if (_submittedNotebook) {
        _notebookLoaded = true;  // Set BEFORE sending to prevent re-entry after reload
        sendToExtension('loadNotebook', {
          notebook: _submittedNotebook,
          path: NOTEBOOK_FILE
        }).then(function (result) {
          console.log('[review] Notebook loaded into JupyterLite:', result);
        }).catch(function (err) {
          console.warn('[review] Failed to load notebook:', err.message);
        });
      }

      // Load submitted files
      if (_submittedFiles && _submittedFiles.length > 0) {
        sendToExtension('loadFiles', {
          files: _submittedFiles
        }).then(function (result) {
          console.log('[review] Files loaded into JupyterLite:', result);
        }).catch(function (err) {
          console.warn('[review] Failed to load files:', err.message);
        });
      }

      // Show the iframe (it will reload itself after loadNotebook)
      if (loadingMsg) loadingMsg.classList.add('hidden');
      _jupyterFrame.style.display = 'block';
    }

    function loadJupyterLite() {
      var url = JUPYTERLITE_URL + '?path=' + encodeURIComponent(NOTEBOOK_FILE);
      console.log('[review] Loading JupyterLite:', url);
      _jupyterFrame.src = url;

      // Fallback: if bridge-shim doesn't signal ready, show iframe anyway
      setTimeout(function () {
        if (!_extensionReady) {
          console.warn('[review] Bridge-shim timeout — showing iframe anyway');
          var loadingMsg = document.getElementById('loading-message');
          if (loadingMsg) loadingMsg.classList.add('hidden');
          _jupyterFrame.style.display = 'block';
        }
      }, 30000);
    }

    // -------------------------------------------------------------------
    // Main: get submission data from Zest, then load JupyterLite
    // -------------------------------------------------------------------
    if (typeof Zest === 'undefined') {
      document.getElementById('loading-message').innerHTML =
        '<div class="no-data">Zest not available</div>';
      return;
    }

    Zest.onReady(function () {
      var submission = Zest.getSubmission();
      if (!submission || !submission.artifacts) {
        document.getElementById('loading-message').innerHTML =
          '<div class="no-data">No submission data available</div>';
        return;
      }

      var artifacts = submission.artifacts;

      // Render stats and timeline
      renderStats(artifacts.stats);
      renderTimeline(artifacts.events);

      // Store notebook and files for loading into JupyterLite when shim is ready
      _submittedNotebook = artifacts.notebook || null;
      _submittedFiles = artifacts.files || [];

      if (!_submittedNotebook) {
        document.getElementById('loading-message').innerHTML =
          '<div class="no-data">No notebook data in submission</div>';
        return;
      }

      // Load JupyterLite to display the submitted notebook
      loadJupyterLite();
    });
  })();
  </script>
</body>
</html>
